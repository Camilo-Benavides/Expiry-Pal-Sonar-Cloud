name: SonarCloud Analysis

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Job 1: Análisis del Backend (Python/Flask)
  backend-analysis:
    name: Backend Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for better analysis

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Backend dependencies
        working-directory: ./Backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pylint flake8

      - name: Run Backend tests with coverage
        working-directory: ./Backend
        run: |
          pytest --cov=src --cov-report=xml --cov-report=html || true
        continue-on-error: true

      - name: Run Pylint
        working-directory: ./Backend
        run: |
          pylint src/ --output-format=json > pylint-report.json || true
        continue-on-error: true

      - name: SonarCloud Scan - Backend
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=Expiry-Pal-Sonar-Cloud
            -Dsonar.organization=your-org-key
            -Dsonar.sources=Backend/src
            -Dsonar.tests=Backend/tests
            -Dsonar.python.coverage.reportPaths=Backend/coverage.xml
            -Dsonar.python.version=3.11
            -Dsonar.sourceEncoding=UTF-8

      - name: Upload Backend coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: Backend/coverage.xml

  # Job 2: Análisis del Frontend (React/Vite)
  frontend-analysis:
    name: Frontend Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: Frontend/package-lock.json

      - name: Install Frontend dependencies
        working-directory: ./Frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./Frontend
        run: |
          npm run lint -- --format json --output-file eslint-report.json || true
        continue-on-error: true

      - name: Run Frontend tests with coverage
        working-directory: ./Frontend
        run: |
          npm test -- --coverage --watchAll=false || true
        continue-on-error: true

      - name: SonarCloud Scan - Frontend
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=Expiry-Pal-Sonar-Cloud
            -Dsonar.organization=your-org-key
            -Dsonar.sources=Frontend/src
            -Dsonar.tests=Frontend/src
            -Dsonar.test.inclusions=**/*.test.js,**/*.test.jsx,**/*.spec.js,**/*.spec.jsx
            -Dsonar.javascript.lcov.reportPaths=Frontend/coverage/lcov.info
            -Dsonar.sourceEncoding=UTF-8

      - name: Upload Frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: Frontend/coverage/

  # Job 3: Quality Gate Check
  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    needs: [backend-analysis, frontend-analysis]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SonarCloud Quality Gate check
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Static code analysis completed! Check SonarCloud for detailed results.'
            })